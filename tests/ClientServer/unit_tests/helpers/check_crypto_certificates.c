/*
 * Licensed to Systerel under one or more contributor license
 * agreements. See the NOTICE file distributed with this work
 * for additional information regarding copyright ownership.
 * Systerel licenses this file to you under the Apache
 * License, Version 2.0 (the "License"); you may not use this
 * file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

#include "check_crypto_certificates.h"

#include <check.h>

#include "sopc_helper_encode.h"
#include "sopc_mem_alloc.h"

// server_2k_cert.der
const char* SRV_CRT =
    "3082052830820310a003020102020108300d06092a864886f70d01010b0500308193310b3009060355040613024652310f300d0603550408"
    "0c064672616e63653111300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e747572792043657274"
    "6966696361746520417574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70632d737570706f72"
    "7440737973746572656c2e6672301e170d3235303132323135303330335a170d3335303132303135303330335a307d310b30090603550406"
    "13024652310f300d06035504080c064672616e63653118301606035504070c0f4169782d656e2d50726f76656e63653111300f060355040a"
    "0c08537973746572656c3130302e06035504030c2753324f50432044656d6f20436572746966696361746520666f72205365727665722054"
    "6573747330820122300d06092a864886f70d01010105000382010f003082010a02820101009bb3fce0a5805a868035e5b1bbe161af33be45"
    "96c9029fe7289e3c4852c9ada105425f96bf732941123e6de1a735cc644229e895e35ba4180c37efe705f1376be650c8f4c6e126cea0f80d"
    "52a033cf7683e127a1e6ae336bb0789c48fe82bd0bc65ac533ea7a605739c07376cef6088cf881ee52eb6ae04fc6dc10cd7059a1b8551531"
    "721d71486bbb8fba8f1d2898cfca991dff31c71da7f72b08303b453fffbb171117ecced93309233fe1172fcb6184b76d6d055671ba56d2d5"
    "61f08ca2828f97c72c10899c603127fc98725a1b8184a1a49b84332400d23d92f3fd5a8b75905b3facbbf72e3b80cde86abecf506e5f4e75"
    "1fe2fd3d169eb02d5674efc6af0203010001a3819b308198301d0603551d0e041604146745aacc412541d8e1d55021fd83e577a3f4e3ea30"
    "1f0603551d230418301680147a46cbd22f30a4ff672913393f9c02bf03d07282300b0603551d0f0404030204f030130603551d25040c300a"
    "06082b0601050507030130090603551d130402300030290603551d1104223020861375726e3a53324f50433a6c6f63616c686f737482096c"
    "6f63616c686f7374300d06092a864886f70d01010b05000382020100527ef1caa33776e297942da74d5aca1fb6558ec0b2947cdc9151dc08"
    "e4d0859421a95f4dc5d9a14446b647b78b496f404c62b96fac039c424eb1f93dd5ead01e2ef2ab1475d9cc0d018e5f7b00cf9124a883930a"
    "ed2a0e9dcf1720340e4737d159c2866e75961e6d6cb7be63cee4b2f6716b3e8e1401e6ae07efbe62a4ffed2a893ce6e5616fd28290017333"
    "22efc0450a7eb821691d74907c93eb121fac0f8b16a982274b5cd3778aa6ff1bb8fafd1be1e44e54723c290061a12e64da8c20b5f3e7971d"
    "89369535cc85215df391f73608540b78617cb5cc1882642a66dbd80a00c117b0addbeabb3d38a4797fc5340a711401b374cbacfec0debea6"
    "214f40495e5d0997f0eb4cdee09228c4548a6728048b339afe25f530a2329ef6e8a46aaf25d65044743ac69ac744682875b6deab8274c44d"
    "ef33734e1d84a4f0aa2b14383fd0745fd906c71f3aa57421caf22ebbc927a6e1a6f62512a9702ed9f6d565da1ec0fe4a4253e7a0d191027b"
    "74587652c283c3db5b6b5be4551f7c1b5eececadc3a153e5573917ca8b94545efc0813fc64941d05acb8ddd134586df370475312448a98c9"
    "59214f5972410d6b91168774f90e9f290739b359632c9afd3960aca9f48ab323a7a40ae8a4a38b346ea2964d4ff4351aff2ace3c71cfd2b0"
    "40f7772461fd6e6153ea3b2c23e18a136b968f660788b0588bd3e1677f0701c5e0828745";

const char* SRV_CRT_THUMB = "04FA0E8580DFAC1BB606199E8EE5D6E9823C5FF8";

// cacert.der
#define CA_CRT_DEFINE                                                                                                  \
    "3082060d308203f5a003020102020900a0b70a15c7b77114300d06092a864886f70d01010b0500308193310b300906035504061302465231" \
    "0f300d06035504080c064672616e63653111300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e74" \
    "75727920436572746966696361746520417574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70" \
    "632d737570706f727440737973746572656c2e66723020170d3138313030343135343735375a180f32313138303931303135343735375a30" \
    "8193310b3009060355040613024652310f300d06035504080c064672616e63653111300f060355040a0c08537973746572656c3136303406" \
    "035504030c2d53324f50432043656e7475727920436572746966696361746520417574686f7269747920666f722054657374733128302606" \
    "092a864886f70d010901161973326f70632d737570706f727440737973746572656c2e667230820222300d06092a864886f70d0101010500" \
    "0382020f003082020a0282020100cfd7b7f13562f1c163e6055bc458c6ed53675feb7b7ca0e8688d4c3ad603a5fe5d854d1667691f9e8e35" \
    "03bea1bedccfb6fc58142bd55a379a4c010782df96fb455e467aa785aec3f9d20f86340477c183235533f8d4522e12e0cbcbf4e61cc8f80f" \
    "6266311c8647020a9eb339debb2e9c8887a841b4a172cfaf2084fdeaa4d5d7d33f711b4f2eee441a549b62dad6bd6631221677dede027c85" \
    "b39fdd6461b7e5696a2f8c1d2273de1e4d796cade386008d41a6ee2f540d4823277c049e9c8f3ccfb7f35d8953d862c10e29ffcbb727abe4" \
    "b37735ad069fa2cfa2e9c7344e0a3a0202fccb4a8798bb7e7c6668bc678c29ea5387be9738674228294b99635c57bb376a101d83a655def9" \
    "b298ab56bbee95be80d53e9c2eeffaf44f1fc31ad6aa1d3da59b154eea7e09bbdb897414097b15d0cfe35a7bc85ad85b4c43d8b74befc4df" \
    "fff3731e459035b5d75b288960a7be2f7caedad2fb7f427d9f923bc6e9bb0d6dde17e408e024c3eb44b0d006c37cd5b3353d8579acc3e7c0" \
    "75de712ae6ae819e054012871f43ff3064ac06538c17ac1e7644f3858d62318039e49cf566b40fe3d4e8981fdeacef039e6726312f8612d8" \
    "8da145fdf55d99f5b336bca673938e426bf25638540c2e80c7af5b8522c30795c74b14af1059c62acb0fa79e563cc907a997155654942cdf" \
    "9dafac4fc9c14f66838eb766539d9843ebb5f93506450203010001a360305e301d0603551d0e041604147a46cbd22f30a4ff672913393f9c" \
    "02bf03d07282301f0603551d230418301680147a46cbd22f30a4ff672913393f9c02bf03d07282300f0603551d130101ff040530030101ff" \
    "300b0603551d0f040403020106300d06092a864886f70d01010b050003820201001fbc525a496d0fab7a62e6074dd994c8c9bdeeb11a34aa" \
    "9f3203c53604826991ca1d02a31c28f9add8dddf63681180902bc5a04a2256c4ea28d44e2343b53af6951db2dce9bffaee596e3fc21f0b02" \
    "58f77f0af3fef4e1bc0d8862d67c8e5c230146be593913bc3ad96807896472f521e4adb74b0af3efeadb48a173a10fcc67577e0dff2feef3" \
    "556e36689dbff5891b95506ea00d2b265a488895a3f66bf4b623466c2f5831c6a58ee455936a620db9f819870a23ee213db19c2fff3ca0c2" \
    "62f22928d1f8c62e8c4aec5e3acdc750e5d44c8c3b43f85a6781b8ae373781f72955389f066e5aca009fece8bd8733ac2ed1250b99c6a95c" \
    "4c0b0cf546cc55c6467f13709e5313ea64872c8ae385e321d3530c21412e061f8c22b6696fc80419bc5901b7424e28fca6721f57c98cfa26" \
    "486e0937764a1ab90be7d59c7ba06eb3cba08d640163a046f2a3aaf23fd783d056af1cae590fff8e1491eefca95c12f3943b8c3876cdf18f" \
    "cd31f03a9a055348e20514397beff7e236aa1b869035b861072aa5bac49af41e4fac8ed8a876fcbeb4b02ab256d9027241d7d2b6167e686a" \
    "328bdc5b16901bf48a0d1448d9a959a8df34f05382d1a00502a18667a16456a0c845c543e899b78959559a6c5543f7067dcebb88c14f6469" \
    "8750488a3fb60a2163d7d504aa470e9c96c69c9fc5ccd84484122743c2c2e5d4df6af8de8952561eb6"

// cacrl.der
#define CA_CRL_DEFINE                                                                                                  \
    "308202dc3081c5300d06092a864886f70d01010b0500308193310b3009060355040613024652310f300d06035504080c064672616e636531" \
    "11300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e747572792043657274696669636174652041" \
    "7574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70632d737570706f72744073797374657265" \
    "6c2e6672170d3138313030343135343735395a180f32313138303931303135343735395a300d06092a864886f70d01010b05000382020100" \
    "26e4802270e2bc1758d7a75294692123e815f4e130a2ed2ef096c232b7ce96700b3764431374cfb8ddc7d23da504dbd9aebba06db3d4e0d4" \
    "dc572b20724856c858e9d17d2ca897cd60e3950d508f5639594e066a1fef4360746297c17d4d2c1ff2afb3e1971c87c19dd77071ec9fae59" \
    "ab3911b3b93f36f2661e46e0dded53ca2fabc36f356ba360837aa8ca673ca7ab3f46fa1ee041b741796b9d30e640d812c31b3d7f45b8a860" \
    "4d1ad19f7a869e52608967b5f0ab73a8bdbbb01ce4dec6d9438ec5d92dc48ba4b4461f9fc5f43625dd2babdfd80e7bfaa79c1de3680233ba" \
    "8a32640f2c1b6056395a261198649d82731fd8ef0697d5d4386bf534b5e1661d56c5974665155545a7ab0eb9ee89f7ca4a0df954355d69a0" \
    "f15fd23162e5c631c4e30b9546e6ba7007068061a7b24c0379f24689fdf3ed6917df2f52b9e5369f838d14a019b1940ae15d95535eb23f71" \
    "f1486c4fd4556701739c76193ce1df3ba354a83f0653d2b90b71ef4c3ebb0efe0ed6390bf4d92bc4528766f9cca6e7a817bd1f3cdd30934a" \
    "3c122f411b594336c7a5fb4c1a786b40a39c458bc6a4afed57409f75c5bed23c379c3fe9836f3dfcce1d64cebd11cb510ae3199156ea1ab2" \
    "976dd2c415a229d8bc2a5ad4753009f4db48fab7bedaf1b529bde7bc7396ec640332c95cf28e4619cae78c40546538322dfeea0fa31d1a8a" \
    "edc9ae42b53ae840"

const char* CA_CRT = CA_CRT_DEFINE;
const size_t CA_CRT_LEN = sizeof(CA_CRT_DEFINE) / 2;

const char* CA_CRL = CA_CRL_DEFINE;
const size_t CA_CRL_LEN = sizeof(CA_CRL_DEFINE) / 2;

SOPC_CertificateList* SOPC_UnhexlifyCertificate(const char* hex_data)
{
    size_t der_len = strlen(hex_data) / 2;
    uint8_t* der_data = SOPC_Calloc(der_len, sizeof(uint8_t));
    ck_assert_ptr_nonnull(der_data);

    SOPC_ReturnStatus status = SOPC_HelperDecode_Hex(hex_data, der_data, der_len);
    ck_assert_int_eq(SOPC_STATUS_OK, status);
    SOPC_CertificateList* crt = NULL;
    ck_assert(der_len <= SIZE_MAX);
    ck_assert_uint_eq(SOPC_STATUS_OK,
                      SOPC_KeyManager_Certificate_CreateOrAddFromDER(der_data, (uint32_t) der_len, &crt));
    SOPC_Free(der_data);

    return crt;
}

SOPC_CRLList* SOPC_UnhexlifyCRL(const char* hex_data)
{
    size_t der_len = strlen(hex_data) / 2;
    uint8_t* der_data = SOPC_Calloc(der_len, sizeof(uint8_t));
    ck_assert_ptr_nonnull(der_data);

    SOPC_CRLList* crl = NULL;
    SOPC_ReturnStatus status = SOPC_HelperDecode_Hex(hex_data, der_data, der_len);
    ck_assert_int_eq(SOPC_STATUS_OK, status);
    ck_assert(der_len <= SIZE_MAX);
    ck_assert_uint_eq(SOPC_STATUS_OK, SOPC_KeyManager_CRL_CreateOrAddFromDER(der_data, (uint32_t) der_len, &crl));
    SOPC_Free(der_data);

    return crl;
}
